---
- name: Update Patroni Consul nodes
  hosts: "{{ _consul_hostgroup }}:!{{ _consul_update_skip_hostgroup }}"
  serial: 1
  become: true
  any_errors_fatal: true
  vars_files:
    - main.yml
  vars:
    update_reboot: false
    update_cache_valid_time: 1
  roles:
    - pokerops.consul.update
  tasks:
    - name: Stop Consul service
      ansible.builtin.service:
        name: consul
        state: stopped

    - name: Reboot node
      ansible.builtin.reboot:

    - name: Verify Consul cluster status
      block:
        - name: Query Consul node cluster status
          ansible.builtin.shell: "consul members listNode | grep {{ inventory_hostname }} | awk '{print $3}'"
          register: _consul_node_status
          changed_when: false
          no_log: true

        - name: Check Consul node cluster status
          ansible.builtin.assert:
            that: _status == _expected
            fail_msg: "Expected consul node type '{{ _expected }}', got '{{ _status }}'"
            success_msg: "Consul node type is '{{ _status }}'"
          vars:
            _status: "{{ _consul_node_status.stdout }}"
            _expected: 'alive'

    - name: Verify Consul node type status
      block:
        - name: Query consul node cluster status
          ansible.builtin.shell: "consul members listNode | grep {{ inventory_hostname }} | awk '{print $4}'"
          register: _consul_node_type
          changed_when: false

        - name: Check consul node cluster status
          ansible.builtin.assert:
            that: _status == _expected
            fail_msg: "Expected consul node type '{{ _expected }}', got '{{ _status }}'"
            success_msg: "Consul node type is '{{ _status }}'"
          vars:
            _status: "{{ _consul_node_type.stdout }}"
            _expected: 'server'
